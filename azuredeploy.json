{
	"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {	
		"importInfoVM": {
			"type": "object",
			"metadata": {
				"description": "Virtual Machine Parameter"
			}
		},
		"importInfoNIC": {
			"type": "object",
			"metadata": {
				"description": "Virtual Machine Parameter"
			}
		},
		"adminUsername": {
            "type": "string",
            "metadata": {
                "description": "Username for the Virtual Machine."
            },
            "defaultValue": "localadmin"
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Password for the Virtual Machine."
            }
        },
		"location": {
			"type": "string",
            "metadata": {
                "description": "Password for the Virtual Machine."
            }
		},
		"virtualNetworks": {
			"type": "object",
            "metadata": {
                "description": "virtualNetworks"
            }
		}
	},
	
	
	
	
	
	"variables": {
		"apiVersion": "2015-01-01",
		"location": "[resourceGroup().location]",
		"baseurl": "https://raw.githubusercontent.com/foxxhot/SK/master/",
		"availabilitySet": [
			{
				"availabilitySetName": "av1",
				"platformFaultDomainCount": "3",
				"platformUpdateDomainCount": "20"
			}
		],

		"storageAccount": [
			{
				"storageAccountType": "Standard_LRS",
				"storageAccountName": "arm1011"
			}
		]
		
	},
	
	
	
	
	"resources": [
	{
		"apiVersion": "[variables('apiVersion')]",
		"name": "[concat('create-storageaccount-',variables('storageAccount')[copyIndex()].storageAccountName)]",
		"type": "Microsoft.Resources/deployments",
		"copy":{
			"name": "copycreateStorageAccount",
			"count":  "[length(variables('storageAccount'))]" 
		},
		"properties": {
			"mode": "incremental",
			"templateLink": {
				"uri": "[concat(variables('baseurl'),'storage-account-create.json')]",
				"contentVersion": "1.0.0.0"
			},
			"parameters": {
				"location": {
					"value": "[variables('location')]"
				},
				"storageAccountType": {
					"value": "[variables('storageAccount')[copyIndex()].storageAccountType]"
				},
				"storageAccountName": {
					"value": "[variables('storageAccount')[copyIndex()].storageAccountName]"
				}
			}
		}
	},
	
	{
		"apiVersion": "[variables('apiVersion')]",
		"name": "[concat('create-availabilityset-',variables('availabilitySet')[copyIndex()].availabilitySetName)]",
		"type": "Microsoft.Resources/deployments",
		"copy":{
			"name": "copycreateAvailabilitySet",
			"count":  "[length(variables('availabilitySet'))]" 
		},
		"properties": {
			"mode": "incremental",
			"templateLink": {
				"uri": "[concat(variables('baseurl'),'availabilityset-create.json')]",
				"contentVersion": "1.0.0.0"
			},
			"parameters": {
				"location": {
					"value": "[parameters('location')]"
				},
				"availabilitySetName": {
					"value": "[variables('availabilitySet')[copyIndex()].availabilitySetName]"
				},
				"platformFaultDomainCount": {
					"value": "[variables('availabilitySet')[copyIndex()].platformFaultDomainCount]"
				},
				"platformUpdateDomainCount": {
					"value": "[variables('availabilitySet')[copyIndex()].platformUpdateDomainCount]"
				}
			}
		}
	},	
	
	
	{
		"apiVersion": "[variables('apiVersion')]",
		"name": "create-vnet",
		"type": "Microsoft.Resources/deployments",
		"properties": {
			"mode": "incremental",
			"templateLink": {
				"uri": "[concat(variables('baseurl'),'vnet-2sub-create.json')]",
				"contentVersion": "1.0.0.0"
			},
			"parameters": {
				"location": {
					"value": "[variables('location')]"
				},
				"virtualNetworks": {
					"value": "[parameters('virtualNetworks')]"
				}
			}
		}
	},

	{
		"apiVersion": "[variables('apiVersion')]",
		"name": "[concat('create-nic-',parameters('importInfoNIC').networkInterfaces[copyIndex()].nicName)]",
		"type": "Microsoft.Resources/deployments",
		"dependsOn": ["Microsoft.Resources/deployments/create-vnet"],
		"copy":{
			"name": "copycreateNic",
			"count": "[length(parameters('importInfoNIC').networkInterfaces)]" 
		},
		"properties": {
			"mode": "incremental",
			"templateLink": {
				"uri": "[concat(variables('baseurl'),'nic-create.json')]",
				"contentVersion": "1.0.0.0"
			},
			"parameters": {
				"location": {
					"value": "[variables('location')]"
				},
				"networkInterfaces": {
					"value": "[parameters('importInfoNIC').networkInterfaces[copyIndex()]]"
				}
			}
		}
	},

	{
		"apiVersion": "[variables('apiVersion')]",
		"name": "[concat('create-vm-',parameters('importInfoVM').virtualMachines[copyIndex()].vmName)]",
		"type": "Microsoft.Resources/deployments",
		"dependsOn": ["copycreateNic","copycreateStorageAccount","copycreateAvailabilitySet"],
		"copy":{
			"name": "copycreateVm",
			"count":  "[length(parameters('importInfoVM').virtualMachines)]" 
		},
		"properties": {
			"mode": "incremental",
			"templateLink": {
				"uri": "[concat(variables('baseurl'),'vm-',parameters('importInfoVM').virtualMachines[copyIndex()].numberOfNic,'nic-av',parameters('importInfoVM').virtualMachines[copyIndex()].availabilitySetExisit,'-create.json')]",
				"contentVersion": "1.0.0.0"
			},
			"parameters": {
				"virtualMachines": {
					"value": "[parameters('importInfoVM').virtualMachines[copyIndex()]]"
				},
				"adminUsername": {
					"value": "[parameters('adminUsername')]"
				},
				"adminPassword": {
					"value": "[parameters('adminPassword')]"
				}
			}
		}
	},	
	
	]
}
